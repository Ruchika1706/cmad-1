pipeline {
   agent any
   tools {
       maven 'Maven 3.6.1'
   }
   stages {
      stage('build') {
         steps {
            echo "Compiling users service"
            when { 
                changeset pattern: "java/cmad-ms-users", comparator: "REGEXP" 
            }
            dir('java/cmad-ms-users'){
               sh 'mvn compile'
            }        
         }
      }
      stage('test') {
         steps {
            echo "Running unit tests on users service"
            when { 
                changeset pattern: "java/cmad-ms-users", comparator: "REGEXP" 
            }
            dir('java/cmad-ms-users'){
               sh 'mvn clean test'
            }
         }
      }
      stage('package') {
         steps {
            when { 
                branch "master"
            }
            echo "Packaging users app"
            dir('java/cmad-ms-users'){
               sh 'mvn package -DskipTests'
            }
         }
      }
   }
}